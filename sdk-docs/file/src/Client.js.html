<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Client.js | GSF JavaScript Client SDK</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="GSF JavaScript Client SDK"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="GSF JavaScript Client SDK"><meta property="twitter:description" content="GSF JavaScript Client SDK"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/geospatial-services-framework"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Job.js~Job.html">Job</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Service.js~Service.html">Service</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Task.js~Task.html">Task</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ClientOptions">ClientOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobInfoList">JobInfoList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobListOptions">JobListOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobAccepted">JobAccepted</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobCompleted">JobCompleted</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobFailed">JobFailed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobProgress">JobProgress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobStarted">JobStarted</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobSucceeded">JobSucceeded</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-GSF">GSF</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobInfo">JobInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobResults">JobResults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NodeInfo">NodeInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ServiceInfo">ServiceInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-InputParameter">InputParameter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobOptions">JobOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobProgressInfo">JobProgressInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobResults">JobResults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-JobStartedInfo">JobStartedInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-OutputParameter">OutputParameter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SubmitOptions">SubmitOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-TaskInfo">TaskInfo</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Client.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import superagent from &apos;superagent&apos;;
import saNoCache from &apos;superagent-no-cache&apos;;
import EventEmitter from &apos;events&apos;;

import utils from &apos;./utils/utils.js&apos;;
import Service from &apos;./Service&apos;;
import Job from &apos;./Job&apos;;
import GSF_API from &apos;./utils/GSF_API&apos;;
import EVENTS from &apos;./utils/EVENTS&apos;;

const nocache = utils.isIE() ? saNoCache.withQueryStrings : saNoCache;

/**
 * The Client class is used to connect to the server and retrieve information
 *  about available services and jobs.
 * @example
 * // Obtain Client object from GSF.
 * const Client = GSF.client({address:&apos;MyServer&apos;,port:9191});
 */
class Client extends EventEmitter {
  /**
   * The ClientOptions object contains information about the server.
   * @typedef {Object} ClientOptions
   * @property {string} ClientOptions.address - The server address/name.
   * @property {string} [ClientOptions.port=null] - The server port.
   * @property {Object} [ClientOptions.headers={}] - The headers to be used in requests.
   * @property {string} [ClientOptions.APIRoot=&apos;&apos;] - The API root endpoint.
   * @property {string} [ClientOptions.protocol=&apos;http&apos;] - The protocol to use.
   */

  /**
   * @param {ClientOptions} clientOptions - The object containing server information.
   * @emits {JobCompleted}
   * @emits {JobSucceeded}
   * @emits {JobFailed}
   * @emits {JobProgress}
   * @emits {JobStarted}
   * @emits {JobAccepted}
   */
  constructor(clientOptions) {
    // Init EventEmitter superclass.
    super();

    /**
     * The server address/name.
     * @type {string}
     */
    this.address = clientOptions.address;

    /**
     * The server port.
     * @type {number}
     */
    this.port = clientOptions.port || null;

    /**
     * The headers to use in requests
     * @type {Object}
     */
    this.headers = clientOptions.headers || {};

    /**
     * The API root endpoint.  If none, set to empty string.
     * @type {string}
     */
    this.APIRoot = clientOptions.APIRoot || GSF_API.ROOT_PATH;

    /**
     * The protocol to use.
     * @type {string}
     */
    this.protocol = clientOptions.protocol || &apos;http&apos;;

    /**
     * The server url.
     * @type {string}
     */
    this.URL = this.protocol + &apos;://&apos; +
      this.address + (this.port ? &apos;:&apos; + this.port : &apos;&apos;);

    /**
     * The API root url.
     * @type {string}
     */
    this.rootURL = (this.APIRoot === &apos;&apos;) ? this.URL : [this.URL, this.APIRoot].join(&apos;/&apos;);

    // Allow infinite listeners.
    this.setMaxListeners(0);

    // Use global EventSource for browsers and the node package for node.
    let Eventsource;
    if (NODE) { // Webpack defined global
      Eventsource = require(&apos;eventsource&apos;);
    } else {
      Eventsource = EventSource;
    }

    // Attach to server sent events and re broadcast.
    // Include headers as query strings.
    let queryString;
    if (this.headers) {
      queryString = Object.keys(this.headers).map((key) =&gt; {
        return encodeURIComponent(key) + &apos;=&apos; +
          encodeURIComponent(this.headers[key]);
      }).join(&apos;&amp;&apos;);
    }

    let url = [this.URL, this.APIRoot,
      GSF_API.EVENTS_PATH].filter((v) =&gt; (v !== &apos;&apos;)).join(&apos;/&apos;);
    url = (queryString) ? (url + &apos;?&apos; + queryString) : (url);

    this._events = new Eventsource(url);

    // Emit succeeded and failed events.
    this.on(EVENTS.completed, (data) =&gt; {
      this.emit(data.success ? EVENTS.succeeded : EVENTS.failed, data);
    });

    // Function to handle server sent events.
    function handler(type, event) {
      try {
        const data = JSON.parse(event.data);
        this.emit(type, data);
      } catch (err) {}
    };

    // Listen for events from our server.  Pass
    // them into the handler with job event type.
    Object.keys(EVENTS).forEach((key) =&gt; {
      // Server doesn&apos;t emit succeeded or failed events.
      if ((EVENTS[key] === EVENTS.succeeded) ||
       (EVENTS[key] === EVENTS.failed)) return;

      // Add a listener for each of the sse&apos;s.
      this._events.addEventListener(EVENTS[key],
        handler.bind(this, EVENTS[key]));
    });
  }

  /**
   * Retrieves an array of available services from the server.
   * @return {Promise&lt;Service[], error&gt;} Returns a Promise to an array of available Service objects.
   */
  services() {
    return new Promise((resolve, reject) =&gt; {
      // Service url.
      const url = [this.rootURL, GSF_API.SERVICES_PATH].join(&apos;/&apos;);

      // Get service list.
      superagent
        .get(url)
        .use(nocache) // Prevents caching of *only* this request
        .set(this.headers)
        .end((err, res) =&gt; {
          if (res &amp;&amp; res.ok) {
            const services = res.body.services;
            const serviceList = services
              .map(service =&gt; new Service(this, service.name));
            resolve(serviceList);
          } else {
            const status = ((err &amp;&amp; err.status) ? &apos;: &apos; + err.status : &apos;&apos;);
            const text = ((err &amp;&amp; err.response &amp;&amp; err.response.text) ? &apos;: &apos; +
             err.response.text : &apos;&apos;);
            reject(&apos;Error requesting services&apos; + status + text);
          }
        });
    });
  }

  /**
   * Filtering options for listing jobs.
   * @typedef {Object} JobListOptions
   * @property {Object} query - Filter jobs by specifying one or more comparison operators per property.
   *   Comparison operators must be prefixed with &apos;$&apos; and only the following are supported: $eq, $ne,
   *  $gt, $gte, $lt, $lte.  Queries may contain multiple properties and each property may
   *  contain multiple comparison operators.
   * @property {Array} sort - The sort array.  This array contains an array for each sort which
   *  consists of the property to sort by and the direction. To sort in ascending order use 1 and
   *  to sort in descending order use -1.  For example, to sort by jobSubmitted date in ascending
   *  order: [ [ &apos;jobSubmitted&apos;, 1 ] ]
   * @property {number} offset - The number of jobs to skip; useful for pagination.
   * @property {number} limit - Limit the number of jobs returned. Set to -1 to
   *  return all jobs. Note: -1 is not recommended, as it may take a long time
   *  to retrieve all jobs.
   * @property {string} totals - Types of total job counts to include in the response.
   *  Must be one of: &apos;all&apos;, &apos;none&apos;, or &apos;default&apos;.  The default is &apos;default&apos;.
   *   Set to &apos;none&apos; to exclude totals.  Set to &apos;default&apos; to include total count of all filtered jobs.
   *   Set to &apos;all&apos; to include total count of all filtered jobs and the total counts of filtered jobs
   *  in each job status.  Totals will only be visible when used with the jobInfoList() function.
   */

  /**
   * Retrieves an array of jobs on the server.
   * @param {JobListOptions} jobListOptions - Object containing options for
   *  filtering job list.
   * @return {Promise&lt;Job[], error&gt;} Returns a Promise to an array of
   *  jobs that exist on the server.
   */
  jobs(jobListOptions) {
    return this
      .jobInfoList(jobListOptions)
      .then((jobInfoList) =&gt; (
        jobInfoList.jobs.map((jobInfo) =&gt; (new Job(this, jobInfo.jobId)))
      ));
  }

  /**
   * A list of JobInfo objects with count and total information.
   * @typedef {Object} JobInfoList
   * @property {JobInfo[]} jobs - An array of JobInfo objects that match the search criteria.
   * @property {string} count - The number of filtered jobs in the jobs array.
   * @property {string} [total] - The total number of jobs.  Enabled by default.
   *   To disable, set &apos;totals&apos; to &apos;none&apos; in the JobListOptions.
   * @property {string} [accepted] - The total number of accepted jobs.
   *   This can be enabled by setting &apos;totals&apos; to &apos;all&apos; in the JobListOptions.
   * @property {string} [started] - The total number of started jobs.
   *   This can be enabled by setting &apos;totals&apos; to &apos;all&apos; in the JobListOptions.
   * @property {string} [succeeded] - The total number of succeeded jobs.
   *   This can be enabled by setting &apos;totals&apos; to &apos;all&apos; in the JobListOptions.
   * @property {string} [failed] - The total number of failed jobs.
   *   This can be enabled by setting &apos;totals&apos; to &apos;all&apos; in the JobListOptions.
   */

  /**
   * Retrieves an array of job info objects.
   * @param {JobListOptions} jobListOptions - Object containing options for
   *  filtering job list.
   * @return {Promise&lt;JobInfoList, error&gt;} Returns a Promise to a JobInfoList object.
   */
  jobInfoList(jobListOptions) {
    return new Promise((resolve, reject) =&gt; {
      // Service url.
      let url = [this.rootURL, GSF_API.JOB_SEARCH_PATH].join(&apos;/&apos;);


      // Get job info list.
      superagent
        .post(url)
        .use(nocache) // Prevents caching of *only* this request
        .set(this.headers)
        .send(jobListOptions || {})
        .then((res) =&gt; {
          resolve(res.body);
        })
        .catch((err) =&gt; {
          const status = ((err &amp;&amp; err.status) ? &apos;: &apos; + err.status : &apos;&apos;);
          const text = ((err &amp;&amp; err.response &amp;&amp; err.response.text) ? &apos;: &apos; +
           err.response.text : &apos;&apos;);
          reject(&apos;Error requesting jobs&apos; + status + text);
        });
    });
  }

  /**
   * Returns the Service object based on service name.
   * @param {string} serviceName - The name of the service.
   * @return {Service} The Service object.
   */
  service(serviceName) {
    return new Service(this, serviceName);
  }

  /**
   * Retrieves job object based on the job ID.
   * @param {string} jobId - The id of the job from which to retrieve the job object.
   * @param {function(info: JobProgressInfo)} [progressCallback] - The callback to handle job progress.
   * @param {function(info: JobStartedInfo)} [startedCallback] - The callback that is called when the job starts.
   *  For more reliable job started information, listen to the GSF JobStarted
   *  events as this callback may not always get called.  In some cases the job
   *  can start before the callback is registered.
   * @return {Job} Returns job object.
   */
  job(jobId, progressCallback, startedCallback) {
    return new Job(this, jobId, progressCallback, startedCallback);
  }

}

export default Client;

/**
 * Emitted when a job completes.
 * @typedef {Object} JobCompleted
 * @property {string} jobId - The job id.
 * @property {boolean} success - A boolean set to true if the job succeeds,
 *  false if it fails.
 */

/**
 * Emitted when a job succeeds.
 * @typedef {Object} JobSucceeded
 * @property {string} jobId - The job id.
 */

/**
 * Emitted when a job fails.
 * @typedef {Object} JobFailed
 * @property {string} jobId - The job id.
 */

/**
 * Emitted when job progress is updated.
 * @typedef {Object} JobProgress
 * @property {string} jobId - The job id.
 * @property {number} progress - The job progress percent.
 * @property {string} [message] - The job progress message, if any.
 */

/**
 * Emitted when a job starts.
 * @typedef {Object} JobStarted
 * @property {string} jobId - The job id.
 */

/**
 * Emitted when a job is accepted.
 * @typedef {Object} JobAccepted
 * @property {string} jobId - The job id.
 */
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
